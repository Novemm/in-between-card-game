<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>In-Between Multiplayer</title>
  <style>
    :root{
      --bg0:#0b1220; --panel: rgba(255,255,255,.06); --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.65);
      --good:#5CFF9D; --bad:#FF5C7A; --warn:#FFD66B; --btn:#1b2a4b; --btn2:#24365f;
      --card:#f7f7fb; --cardStroke:#d8d8e6; --shadow: 0 18px 55px rgba(0,0,0,.55);
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0; display:grid; place-items:center;
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a55 0%, var(--bg0) 55%, #060a14 100%);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      user-select:none; -webkit-user-select:none; touch-action:manipulation;
    }
    .wrap{ width:min(1100px,94vw); display:grid; gap:14px; padding:16px; }
    header{ display:flex; justify-content:space-between; gap:12px; align-items:baseline; flex-wrap:wrap; }
    .title{ font-weight:900; letter-spacing:.2px; font-size: clamp(18px,2.2vw,24px); }
    .sub{ color:var(--muted); font-size:12px; }
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 940px){ .grid{ grid-template-columns:1fr; } }
    .panel{
      background:var(--panel); border:1px solid var(--stroke);
      border-radius:18px; box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{
      padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,.08), rgba(255,255,255,.03));
    }
    .hd .left{ display:flex; flex-direction:column; gap:2px; }
    .kicker{ color:rgba(255,255,255,.55); font-size:11px; letter-spacing:.2px; }
    .big{ font-weight:900; font-size:14px; }
    .bd{ padding:14px; }
    .pill{
      padding:7px 10px; border-radius:999px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill b{ color:var(--text); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row.space{ justify-content:space-between; }
    .btn{
      background: linear-gradient(to bottom, var(--btn2), var(--btn));
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: .2px;
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.07); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; filter:none; }
    input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline: none;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .msg{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      min-height: 54px;
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: .1px;
    }
    .msg.good{ border-color: rgba(92,255,157,.35); }
    .msg.bad{ border-color: rgba(255,92,122,.35); }
    .msg.warn{ border-color: rgba(255,214,107,.35); }
    .cardsRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      align-items:center;
    }
    .slot{ display:grid; justify-items:center; gap:8px; }
    .slotLabel{ color: rgba(255,255,255,.6); font-size: 12px; }
    .card{ width: 150px; height: 210px; perspective: 1000px; }
    @media (max-width: 520px){ .card{ width: 120px; height: 175px; } }
    .cardInner{
      position: relative; width:100%; height:100%;
      transform-style: preserve-3d;
      transition: transform .48s cubic-bezier(.2,.8,.2,1);
    }
    .card.isUp .cardInner{ transform: rotateY(180deg); }
    .face{
      position:absolute; inset:0; border-radius:16px; backface-visibility:hidden;
      display:grid; place-items:center; border:1px solid var(--cardStroke);
    }
    .back{
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.25) 0%, rgba(255,255,255,0) 45%),
                  linear-gradient(135deg, #223a7a, #14224a);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
    }
    .back::after{
      content:""; width:68%; height:68%; border-radius:14px;
      border:2px dashed rgba(255,255,255,.20); transform: rotate(8deg); display:block;
    }
    .front{
      background: var(--card);
      transform: rotateY(180deg);
      box-shadow: 0 14px 28px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .pip{
      position:absolute; top:12px; left:12px; font-weight: 1000; font-size: 18px;
      display:flex; gap:6px; align-items:center;
    }
    .pip.bottom{
      top:auto; left:auto; right:12px; bottom:12px; transform: rotate(180deg);
    }
    .centerSuit{ font-size: 56px; font-weight: 1000; color:#151525; }
    .tiny{ font-size: 11px; color: rgba(255,255,255,.6); line-height: 1.35; }
    .list{
      display:grid; gap:8px;
      padding:12px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background: rgba(255,255,255,.05);
    }
    .playerRow{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      font-size: 12px;
    }
    .playerRow.me{ border-color: rgba(255,214,107,.35); }
    .badge{
      font-size: 10px; font-weight: 1000; padding: 2px 8px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">In-Between Multiplayer (Public Lobby)</div>
      <div class="sub">Anyone with your link joins the same table • Host controls deal/reveal • Play-money chips only</div>
    </div>
    <div class="pill">
      Status: <b id="status">Disconnected</b>
      <span style="opacity:.55">|</span>
      Deck: <b id="deckCount">—</b>
      <span style="opacity:.55">|</span>
      Timer: <b id="timer">—</b>
    </div>
  </header>

  <div class="grid">
    <section class="panel">
      <div class="hd">
        <div class="left">
          <div class="kicker">TABLE</div>
          <div class="big">Host deals 2 cards → everyone bets → auto reveal (or host reveals)</div>
        </div>
        <div class="pill">
          Pair rule: <b id="pairRuleOut">ON</b>
          <span style="opacity:.55">|</span>
          Your chips: <b id="myChips">—</b>
        </div>
      </div>

      <div class="bd">
        <div class="cardsRow">
          <div class="slot">
            <div class="slotLabel">Card 1</div>
            <div class="card" id="c1"><div class="cardInner">
              <div class="face back"></div><div class="face front" id="c1f"></div>
            </div></div>
          </div>
          <div class="slot">
            <div class="slotLabel">Card 2</div>
            <div class="card" id="c2"><div class="cardInner">
              <div class="face back"></div><div class="face front" id="c2f"></div>
            </div></div>
          </div>
          <div class="slot">
            <div class="slotLabel">Result</div>
            <div class="card" id="c3"><div class="cardInner">
              <div class="face back"></div><div class="face front" id="c3f"></div>
            </div></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="msg warn" id="msg">Enter your name and connect.</div>

        <div style="height:12px"></div>

        <div class="row">
          <div style="flex:1; min-width:180px;">
            <div class="tiny">Your display name</div>
            <input id="name" placeholder="Novemm" maxlength="18"/>
          </div>

          <div style="flex:1; min-width:180px;">
            <div class="tiny">Server URL (Render)</div>
            <input id="server" placeholder="https://YOUR_RENDER_URL_HERE" />
            <div class="tiny">Tip: we’ll auto-convert https → wss for WebSocket.</div>
          </div>

          <div class="row" style="align-self:end;">
            <button class="btn" id="connectBtn">Connect</button>
            <button class="btn secondary" id="resetMeBtn" disabled>Reset My Chips</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="row space">
          <div class="row">
            <button class="btn" id="hostNewHand" disabled>Host: New Hand</button>
            <button class="btn secondary" id="hostReveal" disabled>Host: Reveal Now</button>
          </div>
          <div class="row" style="min-width:280px;">
            <div style="flex:1;">
              <div class="tiny">Your bet (0 = sit out)</div>
              <input id="bet" type="number" min="0" step="1" value="10" disabled/>
            </div>
            <button class="btn" id="betBtn" disabled>Place Bet</button>
            <button class="btn secondary" id="sitOutBtn" disabled>Sit Out</button>
          </div>
        </div>

        <div style="height:8px"></div>
        <div class="tiny">
          Classic rule: 3rd card must be <b>strictly between</b> the first two. If first two are a pair and pair-rule is ON, matching pays 11×.
        </div>
      </div>
    </section>

    <aside class="panel">
      <div class="hd">
        <div class="left">
          <div class="kicker">PLAYERS</div>
          <div class="big">Everyone in the link joins here</div>
        </div>
        <div class="pill">
          Host: <b id="hostName">—</b>
        </div>
      </div>
      <div class="bd">
        <div class="list" id="playersList"></div>
        <div style="height:10px"></div>
        <div class="tiny">
          Note: server memory resets if it restarts (free hosting). Everyone can rejoin via the same link.
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
(() => {
  // 1) If you hardcode your Render URL in the placeholder input default, friends won’t need to edit anything.
  const DEFAULT_SERVER = "https://YOUR_RENDER_URL_HERE";

  const el = (id) => document.getElementById(id);

  const statusEl = el("status");
  const deckEl = el("deckCount");
  const timerEl = el("timer");
  const msgEl = el("msg");

  const nameEl = el("name");
  const serverEl = el("server");
  const connectBtn = el("connectBtn");

  const resetMeBtn = el("resetMeBtn");
  const hostNewHandBtn = el("hostNewHand");
  const hostRevealBtn = el("hostReveal");

  const betEl = el("bet");
  const betBtn = el("betBtn");
  const sitOutBtn = el("sitOutBtn");

  const myChipsEl = el("myChips");
  const pairRuleOut = el("pairRuleOut");
  const playersList = el("playersList");
  const hostNameEl = el("hostName");

  const c1 = el("c1"), c2 = el("c2"), c3 = el("c3");
  const c1f = el("c1f"), c2f = el("c2f"), c3f = el("c3f");

  let ws = null;
  let you = null;
  let lastState = null;
  let timerInterval = null;

  function setMsg(kind, text){
    msgEl.classList.remove("good","bad","warn");
    msgEl.classList.add(kind);
    msgEl.textContent = text;
  }

  function toWsUrl(url){
    url = String(url || "").trim();
    if (!url) return "";
    // allow user to paste https://... and convert
    if (url.startsWith("https://")) return "wss://" + url.slice("https://".length);
    if (url.startsWith("http://")) return "ws://" + url.slice("http://".length);
    if (url.startsWith("ws://") || url.startsWith("wss://")) return url;
    // if user pasted bare host
    return "wss://" + url;
  }

  function send(obj){
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
  }

  function renderCard(frontEl, card){
    if (!card) { frontEl.innerHTML = ""; return; }
    frontEl.innerHTML = `
      <div class="pip" style="color:${card.color}">
        <span>${card.rank}</span> <span>${card.suit}</span>
      </div>
      <div class="centerSuit" style="color:${card.color}">${card.suit}</div>
      <div class="pip bottom" style="color:${card.color}">
        <span>${card.rank}</span> <span>${card.suit}</span>
      </div>
    `;
  }

  function flip(cardEl, up){
    cardEl.classList.toggle("isUp", !!up);
  }

  function updateTimer(deadline){
    if (!deadline) { timerEl.textContent = "—"; return; }
    const ms = deadline - Date.now();
    const s = Math.max(0, Math.ceil(ms / 1000));
    timerEl.textContent = s + "s";
  }

  function render(state){
    lastState = state;

    statusEl.textContent = "Connected";
    deckEl.textContent = String(state.deckCount ?? "—");
    pairRuleOut.textContent = state.config?.pairRule ? "ON" : "OFF";

    // Cards
    renderCard(c1f, state.card1);
    renderCard(c2f, state.card2);
    renderCard(c3f, state.card3);

    flip(c1, !!state.card1);
    flip(c2, !!state.card2);
    flip(c3, !!state.card3);

    // Identify host
    const host = (state.players || []).find(p => p.id === state.hostId);
    hostNameEl.textContent = host ? host.name : "—";

    const me = (state.players || []).find(p => p.id === you);
    myChipsEl.textContent = me ? String(me.chips) : "—";

    // Controls
    const isHost = (you && state.hostId === you);

    resetMeBtn.disabled = !you;
    betEl.disabled = !(you && state.phase === "betting");
    betBtn.disabled = !(you && state.phase === "betting");
    sitOutBtn.disabled = !(you && state.phase === "betting");

    hostNewHandBtn.disabled = !(isHost && state.phase !== "betting");
    hostRevealBtn.disabled = !(isHost && state.phase === "betting");

    // Timer tick
    if (timerInterval) clearInterval(timerInterval);
    updateTimer(state.betDeadline);
    timerInterval = setInterval(() => updateTimer(state.betDeadline), 250);

    // Players list
    playersList.innerHTML = "";
    (state.players || []).forEach(p => {
      const row = document.createElement("div");
      row.className = "playerRow" + (p.id === you ? " me" : "");
      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.gap = "8px";
      left.style.alignItems = "center";

      const nm = document.createElement("div");
      nm.textContent = p.name + (p.id === state.hostId ? " (Host)" : "");
      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = p.connected ? "online" : "offline";

      left.appendChild(nm);
      left.appendChild(badge);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "10px";
      right.style.alignItems = "center";
      right.innerHTML = `<span>Chips: <b>${p.chips}</b></span><span>Bet: <b>${p.bet}</b></span><span style="opacity:.75">Δ ${p.lastDelta>=0?"+":""}${p.lastDelta}</span>`;

      row.appendChild(left);
      row.appendChild(right);
      playersList.appendChild(row);
    });

    // Message
    if (state.phase === "idle") {
      setMsg("warn", "Waiting for host to start a new hand.");
    } else if (state.phase === "betting") {
      setMsg("warn", "Betting is open. Place your bet (or sit out). Auto-reveal when timer hits 0.");
    } else if (state.phase === "revealed") {
      setMsg("warn", "Round revealed. Host can start the next hand.");
    }
  }

  connectBtn.addEventListener("click", () => {
    const name = (nameEl.value || "Novemm").trim().slice(0, 18);
    let srv = (serverEl.value || "").trim();
    if (!srv || srv.includes("YOUR_RENDER_URL_HERE")) srv = DEFAULT_SERVER;

    if (!srv || srv.includes("YOUR_RENDER_URL_HERE")) {
      setMsg("bad", "Put your Render server URL in the Server field, then Connect.");
      return;
    }

    const wsUrl = toWsUrl(srv);

    try {
      if (ws) ws.close();
    } catch {}

    setMsg("warn", "Connecting...");
    statusEl.textContent = "Connecting";

    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      statusEl.textContent = "Connected";
      setMsg("good", "Connected. Syncing game...");
      send({ type: "set_name", name });
      // save for next time
      localStorage.setItem("ib_name", name);
      localStorage.setItem("ib_server", srv);
    };

    ws.onmessage = (ev) => {
      let msg;
      try { msg = JSON.parse(ev.data); } catch { return; }

      if (msg.type === "welcome") {
        you = msg.you;
        return;
      }
      if (msg.type === "state") {
        you = msg.you || you;
        render(msg.state);
        return;
      }
    };

    ws.onclose = () => {
      statusEl.textContent = "Disconnected";
      deckEl.textContent = "—";
      timerEl.textContent = "—";
      setMsg("bad", "Disconnected. Click Connect again.");
      if (timerInterval) clearInterval(timerInterval);
    };

    ws.onerror = () => {
      setMsg("bad", "Connection error. Check the server URL and try again.");
    };
  });

  // Actions
  betBtn.addEventListener("click", () => {
    const bet = Math.max(0, Math.floor(Number(betEl.value || 0)));
    send({ type: "place_bet", bet });
  });

  sitOutBtn.addEventListener("click", () => send({ type: "sit_out" }));
  resetMeBtn.addEventListener("click", () => send({ type: "reset_me" }));

  hostNewHandBtn.addEventListener("click", () => send({ type: "host_new_hand" }));
  hostRevealBtn.addEventListener("click", () => send({ type: "host_reveal_now" }));

  // Load saved settings
  nameEl.value = localStorage.getItem("ib_name") || "Novemm";
  serverEl.value = localStorage.getItem("ib_server") || DEFAULT_SERVER;

})();
</script>
</body>
</html>
