<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>In-Between Multiplayer</title>
  <style>
    :root{
      --bg0:#0b1220; --panel: rgba(255,255,255,.06); --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.65);
      --good:#5CFF9D; --bad:#FF5C7A; --warn:#FFD66B;
      --btn:#1b2a4b; --btn2:#24365f; --card:#f7f7fb; --cardStroke:#d8d8e6;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0; display:grid; place-items:center;
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a55 0%, var(--bg0) 55%, #060a14 100%);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      user-select:none; -webkit-user-select:none; touch-action:manipulation;
    }
    .wrap{ width:min(1100px,94vw); display:grid; gap:14px; padding:16px; }
    header{ display:flex; justify-content:space-between; gap:12px; align-items:baseline; flex-wrap:wrap; }
    .title{ font-weight:900; letter-spacing:.2px; font-size: clamp(18px,2.2vw,24px); }
    .sub{ color:var(--muted); font-size:12px; }
    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 940px){ .grid{ grid-template-columns:1fr; } }
    .panel{ background:var(--panel); border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--shadow); overflow:hidden; }
    .hd{
      padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,.08), rgba(255,255,255,.03));
    }
    .hd .left{ display:flex; flex-direction:column; gap:2px; }
    .kicker{ color:rgba(255,255,255,.55); font-size:11px; letter-spacing:.2px; }
    .big{ font-weight:900; font-size:14px; }
    .bd{ padding:14px; }
    .pill{
      padding:7px 10px; border-radius:999px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill b{ color:var(--text); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      background: linear-gradient(to bottom, var(--btn2), var(--btn));
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: .2px;
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.07); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.14); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; filter:none; }
    input{
      padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25); color: var(--text); outline: none; font-weight: 900;
      letter-spacing: .2px;
    }
    .msg{
      padding: 12px; border-radius: 14px; border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05); min-height: 54px;
      display:flex; align-items:center; gap: 10px; font-weight: 900; letter-spacing: .1px;
    }
    .msg.good{ border-color: rgba(92,255,157,.35); }
    .msg.bad{ border-color: rgba(255,92,122,.35); }
    .msg.warn{ border-color: rgba(255,214,107,.35); }

    .summary{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      display:grid;
      gap: 8px;
    }
    .summaryTitle{ font-weight:1000; letter-spacing:.2px; }
    .chipsLine{ color: rgba(255,255,255,.75); font-size:12px; }
    .winLine{ color: var(--good); font-weight: 1000; }
    .loseLine{ color: var(--bad); font-weight: 1000; }
    .potLine{ color: var(--warn); font-weight: 1000; }

    .cardsRow{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items:center; }
    .slot{ display:grid; justify-items:center; gap:8px; }
    .slotLabel{ color: rgba(255,255,255,.6); font-size: 12px; }
    .card{ width: 150px; height: 210px; perspective: 1000px; }
    @media (max-width: 520px){ .card{ width: 120px; height: 175px; } }
    .cardInner{ position: relative; width:100%; height:100%; transform-style: preserve-3d; transition: transform .48s cubic-bezier(.2,.8,.2,1); }
    .card.isUp .cardInner{ transform: rotateY(180deg); }
    .face{ position:absolute; inset:0; border-radius:16px; backface-visibility:hidden; display:grid; place-items:center; border:1px solid var(--cardStroke); }
    .back{
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.25) 0%, rgba(255,255,255,0) 45%),
                  linear-gradient(135deg, #223a7a, #14224a);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
    }
    .back::after{ content:""; width:68%; height:68%; border-radius:14px; border:2px dashed rgba(255,255,255,.20); transform: rotate(8deg); display:block; }
    .front{ background: var(--card); transform: rotateY(180deg); box-shadow: 0 14px 28px rgba(0,0,0,.18); overflow:hidden; }
    .pip{ position:absolute; top:12px; left:12px; font-weight: 1000; font-size: 18px; display:flex; gap:6px; align-items:center; }
    .pip.bottom{ top:auto; left:auto; right:12px; bottom:12px; transform: rotate(180deg); }
    .centerSuit{ font-size: 56px; font-weight: 1000; color:#151525; }
    .tiny{ font-size: 11px; color: rgba(255,255,255,.6); line-height: 1.35; }
    .list{ display:grid; gap:8px; padding:12px; border:1px solid var(--stroke); border-radius:16px; background: rgba(255,255,255,.05); }
    .playerRow{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15); font-size: 12px;
    }
    .playerRow.me{ border-color: rgba(255,214,107,.35); }
    .playerRow.winner{ border-color: rgba(92,255,157,.35); }
    .badge{ font-size: 10px; font-weight: 1000; padding: 2px 8px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06); color: rgba(255,255,255,.75); }

    /* Fireworks/confetti overlay */
    #fx {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 9999;
    }
    .confetti {
      position: absolute;
      top: -10px;
      width: 10px;
      height: 18px;
      border-radius: 3px;
      opacity: 0.95;
      transform: rotate(var(--rot));
      left: var(--x);
      animation: fall var(--dur) linear var(--delay) forwards;
      filter: drop-shadow(0 6px 8px rgba(0,0,0,.25));
    }
    @keyframes fall {
      to { transform: translateY(110vh) rotate(calc(var(--rot) + 360deg)); opacity: 0.8; }
    }
  </style>
</head>
<body>
<div id="fx"></div>

<div class="wrap">
  <header>
    <div>
      <div class="title">In-Between Multiplayer (Manual)</div>
      <div class="sub">Host controls deal & reveal • Winners announced with fireworks • Pot grows only on no-winner rounds</div>
    </div>
    <div class="pill">
      Status: <b id="status">Connecting…</b>
      <span style="opacity:.55">|</span>
      Deck: <b id="deckCount">—</b>
      <span style="opacity:.55">|</span>
      Pot: <b id="potOut">0</b>
    </div>
  </header>

  <div class="grid">
    <section class="panel">
      <div class="hd">
        <div class="left">
          <div class="kicker">TABLE</div>
          <div class="big">Host: New Hand → everyone bets → Host: Reveal</div>
        </div>
        <div class="pill">
          Your chips: <b id="myChips">—</b>
        </div>
      </div>

      <div class="bd">
        <div class="cardsRow">
          <div class="slot">
            <div class="slotLabel">Card 1</div>
            <div class="card" id="c1"><div class="cardInner">
              <div class="face back"></div><div class="face front" id="c1f"></div>
            </div></div>
          </div>
          <div class="slot">
            <div class="slotLabel">Card 2</div>
            <div class="card" id="c2"><div class="cardInner">
              <div class="face back"></div><div class="face front" id="c2f"></div>
            </div></div>
          </div>
          <div class="slot">
            <div class="slotLabel">Result</div>
            <div class="card" id="c3"><div class="cardInner">
              <div class="face back"></div><div class="face front" id="c3f"></div>
            </div></div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="msg warn" id="msg">Connecting…</div>

        <div style="height:12px"></div>
        <div class="summary" id="summary" style="display:none;"></div>

        <div style="height:12px"></div>

        <div class="row">
          <div style="min-width:220px;">
            <div class="tiny">Your name</div>
            <input id="name" maxlength="18" placeholder="Novemm"/>
          </div>
          <button class="btn" id="saveName">Save Name</button>
          <button class="btn secondary" id="resetMeBtn" disabled>Reset My Chips</button>
        </div>

        <div style="height:12px"></div>

        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button class="btn" id="hostNewHand" disabled>Host: New Hand</button>
            <button class="btn secondary" id="hostReveal" disabled>Host: Reveal</button>
          </div>
          <div class="row" style="min-width:320px;">
            <div>
              <div class="tiny">Your bet</div>
              <input id="bet" type="number" min="0" step="1" value="10" disabled/>
            </div>
            <button class="btn" id="betBtn" disabled>Place/Update Bet</button>
            <button class="btn secondary" id="sitOutBtn" disabled>Sit Out</button>
          </div>
        </div>

        <div style="height:8px"></div>
        <div class="tiny">
          Payout: if you win, you gain exactly your bet (+bet). If you lose, you pay your bet (-bet). All-in works automatically.
          If the first two cards are a pair, you only win if the 3rd card matches.
        </div>
      </div>
    </section>

    <aside class="panel">
      <div class="hd">
        <div class="left">
          <div class="kicker">PLAYERS</div>
          <div class="big">Everyone connected to this link</div>
        </div>
        <div class="pill">Host: <b id="hostName">—</b></div>
      </div>
      <div class="bd">
        <div class="list" id="playersList"></div>
      </div>
    </aside>
  </div>
</div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const statusEl = el("status");
  const deckEl = el("deckCount");
  const potOutEl = el("potOut");
  const msgEl = el("msg");
  const summaryEl = el("summary");

  const nameEl = el("name");
  const saveNameBtn = el("saveName");

  const resetMeBtn = el("resetMeBtn");
  const hostNewHandBtn = el("hostNewHand");
  const hostRevealBtn = el("hostReveal");

  const betEl = el("bet");
  const betBtn = el("betBtn");
  const sitOutBtn = el("sitOutBtn");

  const myChipsEl = el("myChips");
  const playersList = el("playersList");
  const hostNameEl = el("hostName");

  const c1 = el("c1"), c2 = el("c2"), c3 = el("c3");
  const c1f = el("c1f"), c2f = el("c2f"), c3f = el("c3f");

  const fx = el("fx");

  let ws = null;
  let you = null;
  let lastCelebratedRound = null;

  function setMsg(kind, text){
    msgEl.classList.remove("good","bad","warn");
    msgEl.classList.add(kind);
    msgEl.textContent = text;
  }

  function wsUrlFromLocation(){
    const proto = (location.protocol === "https:") ? "wss:" : "ws:";
    return proto + "//" + location.host;
  }

  function send(obj){
    if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
  }

  function renderCard(frontEl, card){
    if (!card) { frontEl.innerHTML = ""; return; }
    frontEl.innerHTML = `
      <div class="pip" style="color:${card.color}">
        <span>${card.rank}</span> <span>${card.suit}</span>
      </div>
      <div class="centerSuit" style="color:${card.color}">${card.suit}</div>
      <div class="pip bottom" style="color:${card.color}">
        <span>${card.rank}</span> <span>${card.suit}</span>
      </div>
    `;
  }
  function flip(cardEl, up){ cardEl.classList.toggle("isUp", !!up); }

  function celebrate(){
    // quick confetti burst
    fx.innerHTML = "";
    const pieces = 90;
    for (let i = 0; i < pieces; i++) {
      const d = document.createElement("div");
      d.className = "confetti";
      const x = Math.random() * 100;
      const dur = 1.3 + Math.random() * 1.2;
      const delay = Math.random() * 0.25;
      const rot = (Math.random() * 360) + "deg";
      d.style.setProperty("--x", x + "vw");
      d.style.setProperty("--dur", dur + "s");
      d.style.setProperty("--delay", delay + "s");
      d.style.setProperty("--rot", rot);
      d.style.background = `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`;
      fx.appendChild(d);
    }
    setTimeout(() => { fx.innerHTML = ""; }, 2600);
  }

  function renderSummary(state){
    const lr = state.lastRound;
    if (!lr || state.phase !== "revealed") {
      summaryEl.style.display = "none";
      summaryEl.innerHTML = "";
      return;
    }

    summaryEl.style.display = "grid";

    const winners = lr.winners || [];
    const pot = state.pot ?? 0;

    const lines = [];
    lines.push(`<div class="summaryTitle">Round #${lr.roundId} result</div>`);

    if (winners.length > 0) {
      const winText = winners
        .map(w => `${escapeHtml(w.name)} <span class="winLine">+${w.amount}</span>`)
        .join("<br/>");
      lines.push(`<div class="chipsLine">Winners:</div>`);
      lines.push(`<div>${winText}</div>`);
      lines.push(`<div class="potLine">Pot reset: ${pot}</div>`);
    } else {
      lines.push(`<div class="loseLine">No winners this round.</div>`);
      lines.push(`<div class="potLine">Pot increased to: ${pot}</div>`);
    }

    summaryEl.innerHTML = lines.join("");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function render(state){
    statusEl.textContent = "Connected";
    deckEl.textContent = String(state.deckCount ?? "—");
    potOutEl.textContent = String(state.pot ?? 0);

    renderCard(c1f, state.card1);
    renderCard(c2f, state.card2);
    renderCard(c3f, state.card3);

    flip(c1, !!state.card1);
    flip(c2, !!state.card2);
    flip(c3, !!state.card3);

    const host = (state.players || []).find(p => p.id === state.hostId);
    hostNameEl.textContent = host ? host.name : "—";

    const me = (state.players || []).find(p => p.id === you);
    myChipsEl.textContent = me ? String(me.chips) : "—";

    const isHost = (you && state.hostId === you);

    resetMeBtn.disabled = !you;
    betEl.disabled = !(you && state.phase === "betting");
    betBtn.disabled = !(you && state.phase === "betting");
    sitOutBtn.disabled = !(you && state.phase === "betting");

    hostNewHandBtn.disabled = !(isHost && state.phase !== "betting");
    hostRevealBtn.disabled = !(isHost && state.phase === "betting");

    // Summary + fireworks once per round
    renderSummary(state);
    if (state.phase === "revealed" && state.lastRound?.roundId) {
      const rid = state.lastRound.roundId;
      const hasWinners = (state.lastRound.winners || []).length > 0;
      if (hasWinners && lastCelebratedRound !== rid) {
        lastCelebratedRound = rid;
        celebrate();
        setMsg("good", "We have winner(s)!");
      } else if (!hasWinners) {
        setMsg("warn", "No winners — pot increased.");
      }
    } else if (state.phase === "idle") {
      setMsg("warn", "Waiting for host to start a new hand.");
    } else if (state.phase === "betting") {
      setMsg("warn", "Betting is open. Place/update your bet until host reveals.");
    }

    // Players list (highlight winners)
    const winnerIds = new Set((state.lastRound?.winners || []).map(w => w.id));
    playersList.innerHTML = "";
    (state.players || []).forEach(p => {
      const row = document.createElement("div");
      row.className = "playerRow" + (p.id === you ? " me" : "") + (winnerIds.has(p.id) ? " winner" : "");

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.gap = "8px";
      left.style.alignItems = "center";

      const nm = document.createElement("div");
      nm.textContent = p.name + (p.id === state.hostId ? " (Host)" : "");

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = p.connected ? "online" : "offline";

      left.appendChild(nm);
      left.appendChild(badge);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "10px";
      right.style.alignItems = "center";

      const delta = Number(p.lastDelta || 0);
      const deltaStr = `${delta >= 0 ? "+" : ""}${delta}`;

      right.innerHTML = `<span>Chips: <b>${p.chips}</b></span><span>Bet: <b>${p.bet}</b></span><span style="opacity:.75">Δ ${deltaStr}</span>`;

      row.appendChild(left);
      row.appendChild(right);
      playersList.appendChild(row);
    });
  }

  function connect(){
    setMsg("warn", "Connecting…");
    statusEl.textContent = "Connecting…";

    try { if (ws) ws.close(); } catch {}

    ws = new WebSocket(wsUrlFromLocation());

    ws.onopen = () => {
      statusEl.textContent = "Connected";
      setMsg("good", "Connected. Syncing…");
      const nm = (localStorage.getItem("ib_name") || nameEl.value || "Novemm").trim().slice(0,18);
      if (nm) send({ type:"set_name", name: nm });
    };

    ws.onmessage = (ev) => {
      let msg;
      try { msg = JSON.parse(ev.data); } catch { return; }
      if (msg.type === "welcome") { you = msg.you; return; }
      if (msg.type === "state") { you = msg.you || you; render(msg.state); return; }
    };

    ws.onclose = () => {
      statusEl.textContent = "Disconnected";
      setMsg("bad", "Disconnected. Refresh to reconnect.");
    };

    ws.onerror = () => setMsg("bad", "Connection error. Try refreshing.");
  }

  // UI actions
  saveNameBtn.addEventListener("click", () => {
    const nm = (nameEl.value || "Novemm").trim().slice(0,18);
    if (!nm) return;
    localStorage.setItem("ib_name", nm);
    send({ type:"set_name", name: nm });
    setMsg("good", "Name saved.");
  });

  betBtn.addEventListener("click", () => {
    const bet = Math.max(0, Math.floor(Number(betEl.value || 0)));
    send({ type:"place_bet", bet });
  });

  sitOutBtn.addEventListener("click", () => send({ type:"sit_out" }));
  resetMeBtn.addEventListener("click", () => send({ type:"reset_me" }));
  hostNewHandBtn.addEventListener("click", () => send({ type:"host_new_hand" }));
  hostRevealBtn.addEventListener("click", () => send({ type:"host_reveal_now" }));

  // init
  nameEl.value = localStorage.getItem("ib_name") || "Novemm";
  connect();
})();
</script>
</body>
</html>
